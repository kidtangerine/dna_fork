<?php
/***********************************************************************/
/** 	\file	search_results_map.php

	\brief	This file represents a View layer of the BMLT MVC pattern. It
	will do a meeting search, and display the results as a map. It is not
	an object-oriented file, and is quite simple to use. For many people,
	the procedural View Layer files may be all they need to see. The
	object-oriented stuff is encapsulated within.
	
	This is the map display for the basic HTML implementation of the BMLT.
	
	This file generates HTML structure that is modified by the presentation
	code in the search_results_map.css and search_results_map_print.css
	files.
	
	The way you use this file is to call DisplaySearchResultsMap with an
	array that contains values that specify the search.

    This file is part of the Basic Meeting List Toolbox (BMLT).
    
    Find out more at: http://magshare.org/bmlt

    BMLT is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    BMLT is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this code.  If not, see <http://www.gnu.org/licenses/>.
*/

defined( 'BMLT_EXEC' ) or die ( 'Cannot Execute Directly' );	// Makes sure that this file is in the correct context.

require_once ( dirname ( __FILE__ ).'/../common_search.inc.php' );

/*******************************************************************/
/** \brief This function does a search, then builds an HTML markup
	of a large map result.
	
	\returns a string, containing the HTML generated by the search.
*/
function DisplaySearchResultsMap ( $in_http_vars,	/**< The various HTTP GET and POST parameters.
														 If this is defined and set to 'yes', then that means the client supports AJAX.
															- 'supports_ajax'
																We serve non-JavaScript content to clients that don't support AJAX, even if they support JavaScript.
														 		
														 This is necessary for links:
														 	- 'script_name'
														 		This is the HTTP path to the script.
														 		
														 The values that are important to the list paging are:
														 	- 'bmlt_page'
														 		This is a positive integer, specifying which page of results to display.
														 	
														 	- 'results_per_page'
														 		This is the number of meetings to list on one "page" of results.
														 		The search results are paged, so that a large search is broken
														 		into multiple pages of page_display_size results.
														 	
														 	- 'sort_key'
														 		This is the key to use for sorting. There are three possible values:
														 			- 'town'
														 				This is sorted by town, borough and neighborhood first, weekday and time second.
														 			- 'weekday'
														 				This is sorted by weekday first, town, borough and neighborhood second, then time
														 			- 'time'
														 				This is sorted by weekday first, time, second, then town, borough and neighborhood.
														 	
														 	- 'sort_dir'
														 		This is the direction of the sort. It can be one of the following:
														 			- 'asc'
														 				Ascending, from least to greatest.
														 			- 'desc'
														 				Descending, from greatest to least.
														 	
														 	These are used to specify a search:
																		
															- 'services'
																This is an array of positive integers.
																This is interpreted as an array of integers. Each integer represents the ID of a Service Body.
																A positive integer means that the search will look specifically for meetings that contain that
																Service Body ID.
																If the integer is negative (preceded by a minus sign -), then the criteria will be to look
																for meetings that don't contain that ID.
																If no 'services' values are given, then the search will not use the Service Body field as a
																search criteria.
															
															- 'weekdays'
																This is an array of positive integers ( 1-7).
																This is interpreted as an array of integers. Each integer represents a weekday (1 -> Sunday, 7 -> Saturday).
																A positive integer means that the search will look specifically for meetings that occur on that weekday.
																If the integer is negative (preceded by a minus sign -), then the criteria will be to look
																for meetings that don't occur on that weekday.
																If no 'weekdays' values are given, then the search will not use the weekday field as a
																search criteria.
																
															- 'bmlt_search_type'
																This is set to 'advanced' if the search is an advanced one (we need to take more criteria into consideration).
															
															- 'advanced_search_mode'
																This is set if the call was made from the advanced search page.
															
															- 'advanced_formats'
																This is the formats array, but is only counted if the bmlt_search_type is set to 'advanced'.
															
															- 'advanced_service_bodies'
																This is the same, but for Service Bodies.
															
															- 'advanced_weekdays'
																...and weekdays.
	
															- 'advanced_published'
																This is a switch to indicate whether or not to display published or unpublished meetings.
																It is only viable for logged-in users, and can have these values:
																	- -1	Search for ONLY unpublished meetings
																	-  0	Search for published and unpublished meetings.
																	-  1	Search for ONLY published meetings.

															- 'formats'
																This is an array of positive integers.
																This is interpreted as an array of integers. Each integer represents a format shared ID.
																A format ID means that the search will look specifically for meetings that have that format.
																If the format is negative (preceded by a minus sign -), then the criteria will be to look
																for meetings that don't have that format.
																If no 'formats' values are given, then the search will not use the formats field as a
																search criteria.
															
															- 'langs'
																This is an array of 2-character strings.
																This is interpreted as an array of strings. Each string represents a language code, and is a 2-character string.
																A language string means that the search will look specifically for meetings that are in that language.
																If the language is preceded by a minus sign -, then the criteria will be to look
																for meetings that are not in that language.
																If no 'langs' values are given, then the search will not use the lang_enum field as a
																search criteria.
															
															The following values specify a start time "window." The meeting must start on, or after StartsAfterH/M, and
															can start no later than StartsBeforeH/M
															
															- 'StartsAfterH'
																A positive integer between 0 and 23. The hour of the minimal start time for meetings, in military time.
															- 'StartsAfterM'
																A positive integer between 0 and 59. The minute of the minimal start time for meetings, in military time.
															- 'StartsBeforeH'
																A positive integer between 0 and 23. The hour of the maximal start time for meetings, in military time.
															- 'StartsBeforeM'
																A positive integer between 0 and 59. The minute of the maximal start time for meetings, in military time.
																
															The following values specify a time duration "window." The meeting can last no longer than MaxDurationH/M,
															and no less than MinDurationH/M.
															
															- 'MinDurationH'
																A positive integer. This is the number of hours in the minimal duration.
															- 'MinDurationM'
																A positive integer. This is the number of minutes in the minimal duration.
															- 'MaxDurationH'
																A positive integer. This is the number of hours in the maximal duration.
															- 'MaxDurationM'
																A positive integer. This is the number of minutes in the maximal duration.
																
															This is how meetings are located. We don't use address lookups. Instead, we geolocate the meetings via the
															longitude and latitude fields in each record. If you don't specify a geolocation, then the entire database
															is searched. If you do specify one, then only the portion within the radius is searched.
															
															- 'geo_width'
																A floating point number. This is the radius (not diameter) of the search, in MILES (not Kilometers).
																If this is negative, then it should be an integer, and that indicates an auto-radius is requested to
																find the number of meetings in the integer.
																
															- 'geo_width_km'
																A floating point number. This is the radius (not diameter) of the search, in KILOMETERS (not Miles).
																If this is negative, then it should be an integer, and that indicates an auto-radius is requested to
																find the number of meetings in the integer.
																
															- 'long_val'
																If one of the three radius specifiers is zero or undefined, this is ignored.
																This is a floating point number that specifies the longitude, in degrees, of the center of the search radius.
																
															- 'lat_val'
																If one of the three radius specifiers is zero or undefined, this is ignored.
																This is a floating point number that specifies the latitude, in degrees, of the center of the search radius.
															
															- 'SearchString'
																A string. If this is specified, then all the string fields of the meetings specified by the above criteria
																will be searched for the string. By default, if the language supports metaphone (sound like search), then
																that is used.
																
															- 'StringSearchIsAnAddress'
																A boolean. Nonzero means that the given string should not be checked against any of the fields in the meeting
																data. Instead, it is to be considered a submission to the Google Maps geocode, and will be used to determine
																a cernter point in a local search.
																
															- 'SearchStringAll'
																If nonzero, then all of the words in the search string will have to be matched for a meetings to qualify.
																
															- 'SearchStringExact'
																If nonzero, metaphone will not be used, and the spelling must be exact.
																
															- 'meeting_ids'
																An array of positive integers. Each integer is an ID of an individual meeting. If this is set, all other
																search criteria are ignored.
															
															- 'meeting_key'
																A string. This is the xact name of the key to match. If this is null (Default), the following three are ignored.
																
															- 'meeting_key_value'
																A string. The value to match.
																
															- 'meeting_key_match_case'
																If true, the case must match. Default is false.
																
															- 'meeting_key_contains'
																If this is false, then the string must be complete. Default is true (contains).
													*/
								$in_root_offset = '/../'	/**< This is used for administration. It makes sure that the URIs to the AJAX handlers are referenced correctly.
																 I am not proud of this. It represents a design flaw. My design has a glass jaw, and can't handle the
																 context being shifted around without some handholding.
															*/
								)
{
	if ( !isset ( $in_http_vars['script_name'] ) || !$in_http_vars['script_name'] )
		{
		$script_name = preg_replace ( '|(.*?)\?.*|', "$1", $_SERVER['REQUEST_URI'] );
		}
	else
		{
		$script_name = $in_http_vars['script_name'];
		}
	
	$in_http_vars['script_name'] = preg_replace ( '#(^\/+)|(\/+$)#', '/', $in_http_vars['script_name'] );
	
	if ( !isset ( $in_http_vars['bmlt_root'] ) || !$in_http_vars['bmlt_root'] )
		{
		$in_http_vars['bmlt_root'] = 'http://'.$_SERVER['SERVER_NAME'].dirname ( $_SERVER['SCRIPT_NAME'] ).'/../';
		}
	
	require_once ( dirname ( __FILE__ ).'/../../client/c_comdef_meeting_search_manager.class.php' );
	$search_manager = new c_comdef_meeting_search_manager;

	$localized_strings = c_comdef_server::GetLocalStrings();
	
	// These can be changed in the auto config.
	include ( dirname ( __FILE__ ).'/../../server/config/auto-config.inc.php' );
	$in_http_vars['bmlt_root'] = preg_replace ( '#(^\/+)|(\/+$)#', '/', $in_http_vars['bmlt_root'] );
	if ( $in_http_vars['bmlt_root'] == '/' )
		{
		$in_http_vars['bmlt_root'] = '';
		}
	$location_of_images = preg_replace ( '#(^\/+)|(\/+$)#', '/', $in_http_vars['bmlt_root']."themes/".$localized_strings['theme']."/html/images" );
	$location_of_throbber = "$location_of_images/Throbber.gif";
	$query = null;
	
	foreach ( $in_http_vars as $key => $value )
		{
		switch ( $key )
			{
			case	'script_name':
			case	'bmlt_root':
			case	'disp_format':
			case	'geo_width':
			case	'geo_width_km':
			case	'lat_val':
			case	'gmap_key':
			case	'long_val':
			case	'switcher':
			case	'supports_ajax':
			case	'search_form':
			case	'single_meeting_id':
			case	'redirect_ajax':
			case	'search_spec_map_center':
			case	'preset_service_bodies':
			break;
			
			default:
				if ( is_array ( $value ) )
					{
					foreach ( $value as $v )
						{
						if ( is_array ( $v ) )
							{
							$v = join ( ',', $v );
							}
						$query .= "&".htmlspecialchars ( $key )."[]=".urlencode ( $v );
						}
					}
				elseif ( $value )
					{
					$query .= "&".htmlspecialchars ( $key ). "=".urlencode ( addslashes ( $value ) );
					}
				else
					{
					$query .= "&".htmlspecialchars ( $key );
					}
			break;
			}
		}

	$ajax_call = $in_http_vars['satellite'];
	$ajax_handler = '';
	if ( isset ( $in_http_vars['ajax_handler'] ) && $in_http_vars['ajax_handler'] )
		{
		$ajax_call = preg_replace ( '|^\/\/|', '/', $in_http_vars['ajax_handler'] );
		$ajax_handler = '&ajax_handler='.$in_http_vars['ajax_handler'];
		}
	
	if ( isset ( $in_http_vars['satellite'] ) && $in_http_vars['satellite'] )
		{
		$location_of_map_handler = "$ajax_call?redirect_ajax=search_results_map_ajax.php$ajax_handler$query";
		}
	else
		{
		$query[0] = '?';
		$location_of_map_handler = $in_http_vars['bmlt_root']."client/html/search_results_map_ajax.php$query";
		}

	SetUpSearch ( $search_manager, $in_http_vars );
	$search_manager->DoSearch();
	$radius = $search_manager->GetRadius ( $localized_strings['dist_units'] == 'mi' );

	$r_units = $localized_strings['dist_units'] == 'mi' ? $localized_strings['comdef_search_results_strings']['Radius_Display']['miles'] : $localized_strings['comdef_search_results_strings']['Radius_Display']['km'];
	if ( $radius )
		{
		$query = null;
		
		foreach ( $in_http_vars as $key => $value )
			{
			switch ( $key )
				{
				case	'script_name':
				case	'bmlt_root':
				case	'disp_format':
				case	'geo_width':
				case	'geo_width_km':
				case	'lat_val':
				case	'gmap_key':
				case	'long_val':
				case	'switcher':
				case	'supports_ajax':
				case	'search_form':
				case	'single_meeting_id':
				case	'redirect_ajax':
				case	'search_spec_map_center':
				case	'preset_service_bodies':
				break;
				
				default:
					if ( is_array ( $value ) )
						{
						foreach ( $value as $v )
							{
							if ( is_array ( $v ) )
								{
								$v = join ( ',', $v );
								}
							$query .= "&amp;".htmlspecialchars ( $key )."[]=".urlencode ( $v );
							}
						}
					elseif ( $value )
						{
						$query .= "&amp;".htmlspecialchars ( $key ). "=".urlencode ( addslashes ( $value ) );
						}
					else
						{
						$query .= "&amp;".htmlspecialchars ( $key );
						}
				break;
				}
			}
		
		$ret = "";
		
		// If we are able to edit meetings, then we'll put up a hidden <div>for editing.
		if ( c_comdef_server::GetCurrentUserObj() instanceof c_comdef_user )
			{
			// This is the JavaScript for handling the dynamic and AJAX behavior.
			$pathname = dirname ( __FILE__ ).'/../../admin/admin_meeting.js';
			$script = file_get_contents ( $pathname );
			$script = preg_replace( "|[\n\r]+|s", "\n", $script );
			$script = preg_replace( "|\/\*.*?\*\/|s", "", $script );
			$script = preg_replace( '#\/\/.*?[\n]#', "", $script );
			$script = preg_replace( "|\n+|s", " ", $script );
			$script = preg_replace( "|\t+|s", " ", $script );
			$script = preg_replace( "| +|s", " ", $script );
			$script = str_replace( "##DIRTY_CONFIRM##", c_comdef_htmlspecialchars ( $localized_strings['comdef_search_admin_strings']['Edit_Meeting']['dirty_confirm'] ), $script );
			$script = str_replace( "##DELETE_CONFIRM##", c_comdef_htmlspecialchars ( $localized_strings['comdef_search_admin_strings']['Edit_Meeting']['delete_confirm'] ), $script );
			$script = str_replace( "##REVERT_CONFIRM##", c_comdef_htmlspecialchars ( $localized_strings['comdef_search_admin_strings']['Edit_Meeting']['change_revert_confirm'] ), $script );
			$repl = preg_replace ( '#(^\/+)|(\/+$)#', '/', dirname ( $script_name ).'/admin/change_meeting_ajax.php' );
			$script = str_replace( "##CHANGE_URI##", $repl, $script );
			$repl = preg_replace ( '#(^\/+)|(\/+$)#', '/', dirname ( $script_name ).'/admin/delete_meeting_ajax.php' );
			$script = str_replace( "##DELETE_URI##", $repl, $script );
			$repl = preg_replace ( '#(^\/+)|(\/+$)#', '/', dirname ( $script_name ).'/admin/revert_meeting_ajax.php' );
			$script = str_replace( "##REVERT_URI##", $repl, $script );
			$repl = preg_replace ( '#(^\/+)|(\/+$)#', '/', dirname ( $script_name ).'/admin/format_sorter_ajax.php' );
			$script = str_replace( "##SORT_FORMAT_URI##", $repl, $script );
			$script = str_replace( '##IMAGE_DIR##', $location_of_images, $script );
			$ret .= '<script type="text/javascript">'.$script.'</script>';
			$ret .= '<div id="c_comdef_search_results_edit_hidden_div" style="display:none" class="c_comdef_search_results_edit_hidden_div no_print"></div>';
			$ret .= '<div id="geocoder_browser_edit_meeting_map_div" class="geocoder_browser_edit_meeting_hidden"><div id="goo_map_workplace_container" class="goo_map_workplace_container_div"><noscript><h1>'.c_comdef_htmlspecialchars ( $localized_strings['comdef_search_admin_strings']['Edit_Meeting']['noscript_warning'] ).'</h1></noscript><div id="goo_map_workplace" class="map_work_div"><div id="meeting_map" class="map_square"></div><a href="javascript:CloseMap()">'.c_comdef_htmlspecialchars ( $localized_strings['comdef_search_admin_strings']['Edit_Meeting']['close_window'] ).'</a></div></div></div>';
			}
		
		$ret .= "<div id=\"c_comdef_search_results_single_ajax_div\" class=\"c_comdef_search_results_single_ajax_div\" style=\"display:none\"></div>";
	
		$ret .= "<div id=\"c_comdef_search_results_map_container_div\" class=\"c_comdef_search_results_map_container_div\">";
		
		$ret .= "<div id=\"c_comdef_search_results_single_ajax_throbber_div\" class=\"c_comdef_search_results_single_ajax_throbber_div\"><img id=\"c_comdef_search_results_single_ajax_throbber_img\" class=\"c_comdef_search_results_single_ajax_throbber_img\" alt=\"busy\" src=\"".c_comdef_htmlspecialchars ( $location_of_throbber )."\" /></div>";

		$ret .= "<div id=\"c_comdef_search_results_map_div\" class=\"c_comdef_search_results_map_div\"></div>";
		
		if ( $search_manager instanceof c_comdef_meeting_search_manager )
			{
			$search_results = $search_manager->GetSearchResultsAsArray ( );
			
			$pathname = dirname ( __FILE__ ).'/search_results_list.js';
			$script = file_get_contents ( $pathname );
			$pathname = dirname ( __FILE__ ).'/search_results_map.js';
			$script .= file_get_contents ( $pathname );
			
			$script = preg_replace( "|\/\*.*?\*\/|s", "", $script );
			$script = preg_replace( "|[\n\r]+|s", "\n", $script );
			$script = preg_replace( '#http:\/\/#', '$$HREF$$', $script );
			$script = preg_replace( '#\/\/.*?[\n]#', "", $script );
			$script = str_replace( '$$HREF$$', "http://", $script );

			$location_of_map_handler = preg_replace ( "#&geo_width=.*?([&|$])#", "$1", $location_of_map_handler );
			$location_of_map_handler = preg_replace ( "#&geo_width_km=.*?([&|$])#", "$1", $location_of_map_handler );
			$location_of_map_handler = preg_replace ( "#&geo_width_auto=.*?([&|$])#", "$1", $location_of_map_handler );
			$location_of_map_handler = preg_replace ( "#&long_val=.*?([&|$])#", "$1", $location_of_map_handler );
			$location_of_map_handler = preg_replace ( "#&lat_val=.*?([&|$])#", "$1", $location_of_map_handler );
			$script .= 'main_lat = \''.$in_http_vars['lat_val'].'\'; main_lng = \''.$in_http_vars['long_val'].'\'; main_uri = \''.$location_of_map_handler.'\'; main_radius = \''.$radius.'\'; window.onload = LoadMapMain';			
			$radius_array = array();
			foreach ( $localized_strings['comdef_map_radius_ranges'] as $radius )
				{
				if ( $radius > 0 )
					{
					array_push ( $radius_array, $radius );
					}
				}
			
			$radius_array = 'new Array ('.join(',', $radius_array ).')';
			
			/* This whole page is JavaScript generated, so 90% of the code is in a separate JavaScript file that is downloaded and stripped, then embedded in the page. */

			$list_href = $script_name."?disp_format=force_list$query";
			if ( c_comdef_server::GetCurrentUserObj() instanceof c_comdef_user )
				{
				$repl = preg_replace ( '#(^\/+)|(\/+$)#', '/', dirname ( $script_name ).$in_root_offset.'admin/edit_meeting_ajax.php' );

				$script = str_replace( "##EDIT_URI##", $repl, $script );
				}
			$script = str_replace ( '##IMAGE_DIR##', htmlspecialchars ( $location_of_images ), $script );
			
			$query = null;
			
			foreach ( $in_http_vars as $key => $value )
				{
				switch ( $key )
					{
					case	'script_name':
					case	'disp_format':
					case	'geo_width':
					case	'geo_width_km':
					case	'lat_val':
					case	'long_val':
					case	'gmap_key':
					case	'bmlt_root':
					case	'switcher':
					case	'supports_ajax':
					case	'search_form':
					case	'single_meeting_id':
					case	'redirect_ajax':
					case	'ajax_handler':
					case	'search_spec_map_center':
					case	'preset_service_bodies':
					break;
					
					default:
						if ( is_array ( $value ) )
							{
							foreach ( $value as $v )
								{
								if ( is_array ( $v ) )
									{
									$v = join ( ',', $v );
									}
								$query .= "&amp;".htmlspecialchars ( $key )."[]=".urlencode ( $v );
								}
							}
						elseif ( $value )
							{
							$query .= "&amp;".htmlspecialchars ( $key ). "=".urlencode ( addslashes ( $value ) );
							}
						else
							{
							$query .= "&amp;".htmlspecialchars ( $key );
							}
					break;
					}
				}
			
			if ( isset ( $in_http_vars['satellite'] ) && $in_http_vars['satellite'] )
				{
				$ajax_call = $in_http_vars['satellite'];
				$ajax_handler = '';
				if ( isset ( $in_http_vars['ajax_handler'] ) && $in_http_vars['ajax_handler'] )
					{
					$ajax_call = preg_replace ( '|^\/\/|', '/', $in_http_vars['ajax_handler'] );
					$ajax_handler = '&ajax_handler='.$in_http_vars['ajax_handler'];
					}
				$location_of_single = "$ajax_call?redirect_ajax=search_results_list_ajax.php$ajax_handler&supports_ajax=yes$query";
				}
			else
				{
				$location_of_single = htmlspecialchars ( $in_http_vars['bmlt_root'] )."client/html/search_results_list_ajax.php?supports_ajax=yes$query";
				}
			
			// This will be to ensure that filtered searches work.
			$query = preg_replace ( '/\&?long_val=.*?\&?/', '', $query );
			$query = preg_replace ( '/\&?lat_val=.*?\&?/', '', $query );
			$query = preg_replace ( '/\&?geo_width=.*?\&?/', '', $query );
			$query = preg_replace ( '/\&amp;/', '&', $query );
			$main_uri = "$location_of_map_handler$query";
			
			$filter_message = '';
			
			if ( (isset ( $in_http_vars['bmlt_search_type'] ) && ($in_http_vars['bmlt_search_type'] == 'advanced')
					&& (
							(isset ( $in_http_vars['advanced_weekdays'] ) && is_array ( $in_http_vars['advanced_weekdays'] ) && count ( $in_http_vars['advanced_weekdays'] ))
						||	(isset ( $in_http_vars['advanced_service_bodies'] ) && is_array ( $in_http_vars['advanced_service_bodies'] ) && count ( $in_http_vars['advanced_service_bodies'] ))
						||	(isset ( $in_http_vars['advanced_formats'] ) && is_array ( $in_http_vars['advanced_formats'] ) && count ( $in_http_vars['advanced_formats'] ))
						))
					||	(isset ( $in_http_vars['weekdays'] ) && is_array ( $in_http_vars['weekdays'] ) && count ( $in_http_vars['weekdays'] ))
					||	(isset ( $in_http_vars['services'] ) && is_array ( $in_http_vars['services'] ) && count ( $in_http_vars['services'] ))
					||	(isset ( $in_http_vars['formats'] ) && is_array ( $in_http_vars['formats'] ) && count ( $in_http_vars['formats'] ))
					)
				{
				$filter_message = $localized_strings['comdef_search_results_strings']['Filter_String']['main_message']."\n".$localized_strings['comdef_search_results_strings']['Filter_String']['search_for']."\n";

				if ( (isset ( $in_http_vars['advanced_formats'] ) && is_array ( $in_http_vars['advanced_formats'] ) && count ( $in_http_vars['advanced_formats'] ))
					||	(isset ( $in_http_vars['formats'] ) && is_array ( $in_http_vars['formats'] ) && count ( $in_http_vars['formats'] )) )
					{
					$filter_message .= $localized_strings['comdef_search_results_strings']['Filter_String']['formats'];
					if ( is_array ( $in_http_vars['advanced_formats'] ) && (isset ( $in_http_vars['bmlt_search_type'] ) && ($in_http_vars['bmlt_search_type'] == 'advanced')) )
						{
						$format_codes = $in_http_vars['advanced_formats'];
						}
					elseif ( is_array ( $in_http_vars['formats'] ) )
						{
						$format_codes = $in_http_vars['formats'];
						}
					
					$format_strings = array();
					
					foreach ( $format_codes as $format_code )
						{
						$one_format = c_comdef_server::GetServer()->GetOneFormat ( $format_code, $localized_strings['enum'] );
						
						if ( $one_format instanceof c_comdef_format )
							{
							array_push ( $format_strings, $one_format->GetLocalName() );
							}
						}
					
					$filter_message .= join ( ',', $format_strings )."\n";
					}

				if ( (isset ( $in_http_vars['advanced_service_bodies'] ) && is_array ( $in_http_vars['advanced_service_bodies'] ) && count ( $in_http_vars['advanced_service_bodies'] ))
					||	(isset ( $in_http_vars['services'] ) && is_array ( $in_http_vars['services'] ) && count ( $in_http_vars['services'] )) )
					{
					$filter_message .= $localized_strings['comdef_search_results_strings']['Filter_String']['service_bodies'];
					if ( is_array ( $in_http_vars['advanced_service_bodies'] ) && (isset ( $in_http_vars['bmlt_search_type'] ) && ($in_http_vars['bmlt_search_type'] == 'advanced')) )
						{
						$service_codes = $in_http_vars['advanced_service_bodies'];
						}
					elseif ( is_array ( $in_http_vars['services'] ) )
						{
						$service_codes = $in_http_vars['services'];
						}
					
					$service_strings = array();
					
					foreach ( $service_codes as $service_code )
						{
						$one_sb =& c_comdef_server::GetServer()->GetServiceBodyByIDObj ( $service_code );
						
						if ( $one_sb instanceof c_comdef_service_body )
							{
							array_push ( $service_strings, $one_sb->GetLocalName() );
							}
						}
					
					$filter_message .= join ( ',', $service_strings )."\n";
					}

				if ( (isset ( $in_http_vars['advanced_weekdays'] ) && is_array ( $in_http_vars['advanced_weekdays'] ) && count ( $in_http_vars['advanced_weekdays'] ))
					||	(isset ( $in_http_vars['weekdays'] ) && is_array ( $in_http_vars['weekdays'] ) && count ( $in_http_vars['weekdays'] )) )
					{
					$filter_message .= $localized_strings['comdef_search_results_strings']['Filter_String']['weekdays'];
					if ( is_array ( $in_http_vars['advanced_weekdays'] ) && (isset ( $in_http_vars['bmlt_search_type'] ) && ($in_http_vars['bmlt_search_type'] == 'advanced')) )
						{
						$weekday_codes = $in_http_vars['advanced_weekdays'];
						}
					elseif ( is_array ( $in_http_vars['weekdays'] ) )
						{
						$weekday_codes = $in_http_vars['weekdays'];
						}
					
					$weekday_strings = array();
					
					foreach ( $weekday_codes as $weekday_code )
						{
						array_push ( $weekday_strings, $localized_strings['weekdays'][$weekday_code-1] );
						}
					
					$filter_message .= join ( ',', $weekday_strings );
					}
				
				$filter_message = '<div class="filter_message_div">'.str_replace ( "\n", "<br />", c_comdef_htmlspecialchars ( $filter_message ) ).'</div>';
				}

			$script = str_replace ( '##FILTER_MESSAGE##', $filter_message, $script );
			$script = str_replace ( '##MAIN_URI##', $main_uri, $script );
			if ( isset ( $in_http_vars['satellite'] ) && $in_http_vars['satellite'] )
				{
				$ajax_call = $in_http_vars['satellite'];
				$ajax_handler = '';
				if ( isset ( $in_http_vars['ajax_handler'] ) && $in_http_vars['ajax_handler'] )
					{
					$ajax_call = preg_replace ( '|^\/\/|', '/', $in_http_vars['ajax_handler'] );
					$ajax_handler = '&ajax_handler='.htmlspecialchars ( $in_http_vars['ajax_handler'] );
		
					// Make sure we don't have double-slashes (Bit of a hack)
					$ajax_handler = preg_replace ( '|^\/\/|', '/', $ajax_handler );
					}
				$pathname = "$ajax_call?redirect_ajax=contact_form.php$ajax_handler&supports_ajax=yes&contact_form&meeting_id=";
				}
			else
				{
				$pathname = $in_http_vars['bmlt_root'].'client/html/contact_form.php?contact_form&meeting_id=';
				}

			$script = str_replace( "##CONTACT_URI##", $pathname, $script );
			$script = str_replace ( '##SINGLE_URI##', $location_of_single, $script );
			$script = str_replace ( '##RADIUS_ARRAY##', c_comdef_htmlspecialchars ( $radius_array ), $script );
			$script = str_replace ( '##RADIUS_ARRAY_UNIT_STRING##', c_comdef_htmlspecialchars ( $r_units ), $script );
			$script = str_replace ( '##RADIUS_ARRAY_UNIT##', c_comdef_htmlspecialchars ( $localized_strings['dist_units'] ), $script );
			$script = str_replace ( '##RADIUS_ARRAY_PROMPT##', c_comdef_htmlspecialchars ( $localized_strings['comdef_search_results_strings']['main_info_radius_prompt'] ), $script );
			$script = str_replace ( '##CENTER_TITLE##', c_comdef_htmlspecialchars ( $localized_strings['comdef_search_results_strings']['main_map_center_title'] ), $script );
			$script = str_replace ( '##LIST_LINK##', $list_href, $script );
			$script = str_replace ( '##LIST_LINK_TITLE##', c_comdef_htmlspecialchars ( $localized_strings['comdef_search_results_strings']['main_map_list_link_title'] ), $script );
			$script = str_replace ( '##LIST_LINK_TEXT##', c_comdef_htmlspecialchars ( $localized_strings['comdef_search_results_strings']['main_map_list_link_text'] ), $script );
			$script = str_replace ( '##MARKER_WINDOW_SEPARATOR##', $localized_strings['prompt_delimiter'], $script );

			$script = preg_replace( "|\n+|s", " ", $script );
			$script = preg_replace( "|\t+|s", " ", $script );
			$script = preg_replace( "| +|s", " ", $script );
			$ret .= '<script type="text/javascript">'.$script.'</script>';
			}
		
		$ret .= "</div>";
		}
	else
		{
		$ret = '<div class="c_comdef_search_no_results_div">'.$localized_strings['comdef_search_results_strings']['Search_Form']['lookup_failed_alert'].'</div>';
		}
	return $ret;
}
?>